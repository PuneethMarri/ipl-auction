<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPL Auction - Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #0a0e27;
            color: #fff;
        }
        .test-box {
            background: #1a1f3a;
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .pass { color: #4CAF50; }
        .fail { color: #ff4444; }
        .pending { color: #ff9800; }
        button {
            background: #d4af37;
            border: none;
            padding: 15px 30px;
            color: #000;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        #log {
            background: #000;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üîç IPL Auction Debug Test</h1>
    
    <div class="test-box">
        <h2>Step 1: Check Files</h2>
        <div id="test1" class="pending">‚è≥ Testing...</div>
        <button onclick="testFiles()">üîÑ Retest Files</button>
    </div>
    
    <div class="test-box">
        <h2>Step 2: Check Firebase Connection</h2>
        <div id="test2" class="pending">‚è≥ Testing...</div>
        <button onclick="testFirebase()">üîÑ Retest Firebase</button>
    </div>
    
    <div class="test-box">
        <h2>Step 3: Create Test Room</h2>
        <input type="text" id="testRoomId" placeholder="Room ID" value="debugtest" style="padding: 10px; margin: 5px; border-radius: 5px;">
        <input type="text" id="testPassword" placeholder="Password" value="123" style="padding: 10px; margin: 5px; border-radius: 5px;">
        <br>
        <button onclick="createTestRoom()">‚ûï Create Test Room</button>
        <div id="test3" class="pending"></div>
    </div>
    
    <div class="test-box">
        <h2>Step 4: Join Test Room</h2>
        <button onclick="joinTestRoom()">üö™ Join Test Room</button>
        <div id="test4" class="pending"></div>
    </div>
    
    <div id="log"></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBJBwF80s_3to-kNB7-TU9BZtkNQIOhEis",
            authDomain: "ipl-auction-70480.firebaseapp.com",
            databaseURL: "https://ipl-auction-70480-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ipl-auction-70480",
            storageBucket: "ipl-auction-70480.firebasestorage.app",
            messagingSenderId: "494392409078",
            appId: "1:494392409078:web:551592b7ddb0fa7b2ce5d7"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        window.db = database;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbGet = get;
        window.dbRemove = remove;
        
        let allPlayers = [];
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff4444' : type === 'success' ? '#4CAF50' : '#fff';
            logDiv.innerHTML += `<div style="color: ${color};">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        window.log = log;
        
        // Test 1: Check Files
        window.testFiles = async function() {
            log('üîç Testing file access...', 'info');
            const test1 = document.getElementById('test1');
            
            try {
                // Test players.csv
                log('Fetching players.csv...', 'info');
                const response = await fetch('players.csv');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const csvText = await response.text();
                const lines = csvText.split('\n');
                
                log(`‚úÖ players.csv loaded: ${lines.length} lines`, 'success');
                
                // Parse players
                allPlayers = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const cols = line.split(',');
                    if (cols[1]) {
                        allPlayers.push({
                            id: i,
                            name: cols[1],
                            role: cols[2] || 'Batsman'
                        });
                    }
                }
                
                log(`‚úÖ Parsed ${allPlayers.length} players`, 'success');
                log(`Sample: ${allPlayers[0].name}, ${allPlayers[1].name}, ${allPlayers[2].name}`, 'success');
                
                test1.className = 'pass';
                test1.innerHTML = `‚úÖ PASS: ${allPlayers.length} players loaded from CSV`;
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                test1.className = 'fail';
                test1.innerHTML = `‚ùå FAIL: ${error.message}<br><br>
                    <strong>Fix:</strong> Make sure players.csv is uploaded to GitHub in the same folder as index.html`;
            }
        };
        
        // Test 2: Check Firebase
        window.testFirebase = async function() {
            log('üîç Testing Firebase connection...', 'info');
            const test2 = document.getElementById('test2');
            
            try {
                const testRef = window.dbRef(window.db, 'test-connection');
                
                log('Writing test data...', 'info');
                await window.dbSet(testRef, {
                    test: true,
                    timestamp: Date.now()
                });
                
                log('Reading test data...', 'info');
                const snapshot = await window.dbGet(testRef);
                
                if (snapshot.exists()) {
                    log('‚úÖ Firebase read/write working', 'success');
                    
                    // Clean up
                    await window.dbRemove(testRef);
                    log('‚úÖ Test data cleaned up', 'success');
                    
                    test2.className = 'pass';
                    test2.innerHTML = '‚úÖ PASS: Firebase connected and working';
                } else {
                    throw new Error('Could not read data back');
                }
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                test2.className = 'fail';
                test2.innerHTML = `‚ùå FAIL: ${error.message}<br><br>
                    <strong>Fix:</strong> Set Firebase Database Rules:<br>
                    <code>{
  "rules": {
    "rooms": {
      "$roomId": {
        ".read": true,
        ".write": true
      }
    }
  }
}</code>`;
            }
        };
        
        // Test 3: Create Room
        window.createTestRoom = async function() {
            log('üîç Creating test room...', 'info');
            const test3 = document.getElementById('test3');
            const roomId = document.getElementById('testRoomId').value;
            const password = document.getElementById('testPassword').value;
            
            try {
                if (allPlayers.length === 0) {
                    throw new Error('No players loaded. Run Test 1 first!');
                }
                
                const roomRef = window.dbRef(window.db, `rooms/${roomId}`);
                
                log(`Creating room: ${roomId}`, 'info');
                await window.dbSet(roomRef, {
                    password: password,
                    host: 'TestHost',
                    createdAt: Date.now(),
                    playerCount: allPlayers.length,
                    participants: {
                        TestHost: {
                            team: 'Mumbai Indians',
                            ready: false,
                            isHost: true
                        }
                    }
                });
                
                log('‚úÖ Room created successfully', 'success');
                log(`Room ID: ${roomId}, Password: ${password}`, 'success');
                
                test3.className = 'pass';
                test3.innerHTML = `‚úÖ PASS: Room "${roomId}" created`;
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                test3.className = 'fail';
                test3.innerHTML = `‚ùå FAIL: ${error.message}`;
            }
        };
        
        // Test 4: Join Room
        window.joinTestRoom = async function() {
            log('üîç Joining test room...', 'info');
            const test4 = document.getElementById('test4');
            const roomId = document.getElementById('testRoomId').value;
            const password = document.getElementById('testPassword').value;
            
            try {
                const roomRef = window.dbRef(window.db, `rooms/${roomId}`);
                const snapshot = await window.dbGet(roomRef);
                
                if (!snapshot.exists()) {
                    throw new Error('Room not found! Create it first (Test 3)');
                }
                
                const roomData = snapshot.val();
                
                if (roomData.password !== password) {
                    throw new Error('Incorrect password!');
                }
                
                log('‚úÖ Room found and password correct', 'success');
                log(`Participants: ${Object.keys(roomData.participants || {}).length}`, 'success');
                
                test4.className = 'pass';
                test4.innerHTML = `‚úÖ PASS: Successfully joined room "${roomId}"`;
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                test4.className = 'fail';
                test4.innerHTML = `‚ùå FAIL: ${error.message}`;
            }
        };
        
        // Auto-run tests on load
        setTimeout(() => {
            log('üöÄ Starting automatic tests...', 'info');
            testFiles();
            setTimeout(() => testFirebase(), 1000);
        }, 500);
    </script>
</body>
</html>
